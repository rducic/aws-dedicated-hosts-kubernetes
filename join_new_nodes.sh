#!/bin/bash

# Get the list of new dedicated worker IPs (excluding the first 2 which are already joined)
NEW_IPS=(
  "18.236.177.241" "52.32.181.162" "34.216.187.28" "18.237.183.186" "35.92.136.109" "35.90.62.181"
  "44.251.231.49" "44.252.102.70" "52.38.96.242" "34.219.198.177" "52.42.1.28" "44.244.117.250"
  "34.209.240.226" "34.208.9.58" "44.252.41.56" "35.161.34.19" "35.87.24.200" "35.92.162.51"
  "44.247.250.154" "52.38.105.13" "34.214.84.103" "54.184.209.148" "35.87.98.83" "44.246.193.45"
  "52.41.37.43" "54.184.1.214" "18.237.105.189" "34.208.30.252" "44.243.128.249" "35.90.64.62"
  "34.222.5.38" "16.144.68.157" "44.251.7.202" "44.247.75.9" "54.149.2.10" "44.247.125.6"
  "34.218.228.234" "54.186.143.9" "44.251.220.10" "35.94.69.159" "44.249.149.25" "34.212.161.31"
  "34.216.12.45" "35.86.93.70" "54.213.174.71" "34.214.8.76" "34.212.34.211" "34.208.121.43"
  "54.185.200.35" "34.221.12.116" "44.252.93.148" "52.89.104.23" "52.13.107.157" "35.92.97.58"
  "34.208.9.250" "44.246.189.176" "18.236.151.92" "54.213.125.76" "18.236.101.120" "35.163.90.140"
  "35.167.240.166" "54.148.238.193" "52.39.195.64" "44.247.100.26" "34.219.176.161" "34.220.156.90"
  "18.236.164.90" "35.88.180.123" "44.246.132.219" "34.219.190.64" "35.85.147.17" "44.248.36.65"
  "18.246.242.174" "54.188.179.119" "54.191.39.26" "44.246.135.76" "44.249.14.106" "35.92.65.65"
  "44.251.128.132" "44.244.1.253" "34.219.155.169" "44.252.39.228" "52.27.220.158" "54.213.150.8"
  "54.218.35.87" "44.245.93.237" "54.190.62.109" "35.91.47.129" "35.94.45.48" "54.184.195.41"
  "54.218.121.40" "35.92.233.106" "34.219.31.234" "44.249.62.58"
)

JOIN_COMMAND="sudo kubeadm join 10.0.1.128:6443 --token 8bdq9d.3g9lgaw0da0rq31a --discovery-token-ca-cert-hash sha256:0cff80d065551d4fb6159120ab90324fe6986c49ba9cf9f687fc76c52635ae2e"

echo "🚀 Joining ${#NEW_IPS[@]} new nodes to the cluster..."

# Join nodes in parallel batches of 10
BATCH_SIZE=10
for ((i=0; i<${#NEW_IPS[@]}; i+=BATCH_SIZE)); do
    echo "Processing batch $((i/BATCH_SIZE + 1))..."
    
    for ((j=i; j<i+BATCH_SIZE && j<${#NEW_IPS[@]}; j++)); do
        IP=${NEW_IPS[j]}
        NODE_NUM=$((j+3))  # Start from k8s-dedicated-3
        echo "Joining node k8s-dedicated-$NODE_NUM ($IP)..."
        
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ec2-user@$IP \
            "$JOIN_COMMAND --node-name=k8s-dedicated-$NODE_NUM" &
    done
    
    # Wait for this batch to complete
    wait
    echo "Batch $((i/BATCH_SIZE + 1)) completed"
    sleep 5
done

echo "✅ All nodes join commands sent!"
echo "⏳ Waiting for nodes to become ready..."
sleep 30

# Check final node count
kubectl get nodes --insecure-skip-tls-verify | grep -c Ready